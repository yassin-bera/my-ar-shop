<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AR Smart Gallery</title>
    
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>

    <style>
        :root {
            --primary: #00b894; --surface: rgba(255, 255, 255, 0.96);
            --font: 'Vazirmatn', sans-serif;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; height: 100dvh; width: 100vw; overflow: hidden; font-family: var(--font); background: #b2bec3; }
        
        /* Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø§ØµÙ„ÛŒ */
        .viewer-wrap { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        model-viewer { 
            width: 100%; height: 100%; 
            background: radial-gradient(circle at 50% 50%, #f5f6fa 0%, #dcdde1 100%);
            --poster-color: transparent; 
            touch-action: none; /* Ø­ÛŒØ§ØªÛŒ Ø¨Ø±Ø§ÛŒ Ø²ÙˆÙ… Ø¨Ø§ Ø§Ù†Ú¯Ø´Øª */
        }

        /* Ù¾Ù†Ù„ Ú©Ù†ØªØ±Ù„ */
        .panel {
            position: absolute; bottom: 0; left: 0; width: 100%; z-index: 20;
            background: var(--surface); 
            padding: 20px; padding-bottom: max(20px, env(safe-area-inset-bottom));
            border-radius: 24px 24px 0 0;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.15);
        }
        @media (min-width: 768px) { .panel { width: 400px; left: 50%; bottom: 20px; transform: translateX(-50%); border-radius: 24px; } }

        /* ØªØ¨â€ŒÙ‡Ø§ */
        .tabs { display: flex; gap: 8px; background: #eee; padding: 5px; border-radius: 12px; margin-bottom: 15px; }
        .tab { flex: 1; padding: 12px; border: none; background: transparent; border-radius: 8px; font-family: inherit; color: #666; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .tab.active { background: #fff; color: #333; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* Ù„ÛŒØ³Øª Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ */
        .list { display: flex; gap: 12px; overflow-x: auto; padding: 5px; scrollbar-width: none; }
        .list::-webkit-scrollbar { display: none; }
        .item { 
            flex: 0 0 auto; width: 70px; height: 70px; background: #fff; border-radius: 16px;
            display: flex; align-items: center; justify-content: center; font-size: 2rem;
            border: 2px solid transparent; transition: 0.2s; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .item.active { border-color: var(--primary); background: #e0f2f1; transform: scale(1.05); }

        /* Ú©Ù†ØªØ±Ù„Ø±Ù‡Ø§ */
        .controls { margin-top: 15px; background: #f1f2f6; padding: 12px; border-radius: 12px; }
        .ctrl-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; }
        .ctrl-label { font-size: 0.8rem; font-weight: bold; color: #555; }
        input[type=range] { width: 100%; accent-color: var(--primary); margin-top: 8px; }

        /* Ø¯Ú©Ù…Ù‡ AR */
        .ar-btn {
            width: 100%; margin-top: 15px; padding: 16px; border: none; border-radius: 14px;
            background: var(--primary); color: white;
            font-family: inherit; font-weight: 800; font-size: 1rem; cursor: pointer;
            display: flex; justify-content: center; gap: 10px;
        }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ */
        .colors { display: flex; justify-content: center; gap: 10px; margin-top: 10px; }
        .color { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .loader { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 10px 20px; background: rgba(0,0,0,0.7); color: white; border-radius: 20px; font-size: 0.9rem; display: none; z-index: 50; }
        button[slot="ar-button"] { display: none; }
    </style>
</head>
<body>

    <div class="loader" id="loader">Ø¯Ø± Ø­Ø§Ù„ ØªÙ†Ø¸ÛŒÙ… Ø§Ø¨Ø¹Ø§Ø¯...</div>

    <div class="viewer-wrap">
        <model-viewer 
            id="viewer" 
            src="" 
            ar 
            ar-modes="webxr scene-viewer quick-look" 
            camera-controls 
            shadow-intensity="1" 
            shadow-softness="0.5" 
            touch-action="none"
            auto-rotate>
        </model-viewer>
    </div>

    <div class="panel">
        <div class="tabs">
            <button class="tab active" onclick="setMode('pots')">ğŸº Ú¯Ù„Ø¯Ø§Ù†</button>
            <button class="tab" onclick="setMode('carpets')">ğŸ§¶ ÙØ±Ø´</button>
        </div>

        <div class="list" id="list"></div>

        <div class="controls">
            <div class="ctrl-row">
                <span class="ctrl-label">ØªÙ†Ø¸ÛŒÙ… Ø¯Ù‚ÛŒÙ‚ Ø§Ù†Ø¯Ø§Ø²Ù‡:</span>
                <span class="ctrl-label" id="size-display">100%</span>
            </div>
            <input type="range" min="0.1" max="3" step="0.1" value="1" id="slider" oninput="manualResize(this.value)">
        </div>

        <div class="colors" id="colors-panel">
            <div class="color" style="background:#fff" onclick="tint('#ffffff')"></div>
            <div class="color" style="background:#333" onclick="tint('#333333')"></div>
            <div class="color" style="background:#e74c3c" onclick="tint('#e74c3c')"></div>
        </div>

        <button class="ar-btn" onclick="startAR()">
            ğŸ“· Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¯Ø± Ù…Ø­ÛŒØ·
        </button>
    </div>

    <script>
        const viewer = document.querySelector('#viewer');
        const listEl = document.querySelector('#list');
        const slider = document.querySelector('#slider');
        const loader = document.querySelector('#loader');
        const colorsPanel = document.querySelector('#colors-panel');
        
        let currentMode = 'pots';
        let calculatedScale = 1; // Ø¶Ø±ÛŒØ¨ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· Ø³ÛŒØ³ØªÙ…

        // Ø¯ÛŒØªØ§Ø¨ÛŒØ³
        const db = {
            pots: [
                { src: "./pot1.glb", icon: "ğŸª´" },
                { src: "./pot2.glb", icon: "ğŸŒµ" },
                { src: "./pot3.glb", icon: "ğŸº" },
                { src: "./pot4.glb", icon: "ğŸŒ»" },
                { src: "./pot5.glb", icon: "ğŸ" }
            ],
            carpets: [
                { src: "./carpet1.glb", icon: "ğŸ§¶" },
                { src: "./carpet2.glb", icon: "ğŸ¦" },
                { src: "./carpet3.glb", icon: "ğŸ¨" },
                { src: "./carpet4.glb", icon: "ğŸ’ " },
                { src: "./carpet5.glb", icon: "ğŸŒ·" }
            ]
        };

        // Ø´Ø±ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡
        function init() {
            setMode('pots');
            
            // Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ù„ÙˆØ¯ Ø´Ø¯Ù† Ù…Ø¯Ù„ Ø¨Ø±Ø§ÛŒ Ù†Ø±Ù…Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø³Ø§ÛŒØ²
            viewer.addEventListener('load', () => {
                normalizeModelSize();
                loader.style.display = 'none';
            });
            
            viewer.addEventListener('progress', () => {
                loader.style.display = 'block';
            });
        }

        function setMode(mode) {
            currentMode = mode;
            
            // UI Update
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event ? event.target.classList.add('active') : document.querySelector('.tab').classList.add('active'); // Fallback
            
            colorsPanel.style.display = mode === 'pots' ? 'flex' : 'none';
            
            renderList();
        }

        function renderList() {
            listEl.innerHTML = '';
            db[currentMode].forEach((item, index) => {
                const el = document.createElement('div');
                el.className = 'item';
                if (index === 0 && !viewer.src) {
                    el.classList.add('active');
                    loadItem(item);
                }
                el.innerHTML = item.icon;
                el.onclick = () => {
                    document.querySelectorAll('.item').forEach(i => i.classList.remove('active'));
                    el.classList.add('active');
                    loadItem(item);
                };
                listEl.appendChild(el);
            });
        }

        function loadItem(item) {
            viewer.src = item.src;
            // Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† Ø§Ø³Ù„Ø§ÛŒØ¯Ø±
            slider.value = 1;
            document.getElementById('size-display').innerText = "100%";
        }

        // --- ğŸ§  Ù…ØºØ² Ù…ØªÙÚ©Ø±: Ù†Ø±Ù…Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø³Ø§ÛŒØ² ---
        async function normalizeModelSize() {
            if (!viewer.model) return;

            // ØµØ¨Ø± Ù…ÛŒÚ©Ù†ÛŒÙ… ØªØ§ ÙØ±ÛŒÙ… Ø±Ù†Ø¯Ø± Ø´ÙˆØ¯ Ùˆ Ø§Ø¨Ø¹Ø§Ø¯ Ø¯Ù‚ÛŒÙ‚ Ø¨Ø¯Ø³Øª Ø¢ÛŒØ¯
            await new Promise(resolve => requestAnimationFrame(resolve));

            // Ø¨Ø¯Ø³Øª Ø¢ÙˆØ±Ø¯Ù† Ø§Ø¨Ø¹Ø§Ø¯ ÙˆØ§Ù‚Ø¹ÛŒ Ù…Ø¯Ù„ (Ø¨Ø¯ÙˆÙ† Ø¯Ø± Ù†Ø¸Ø± Ú¯Ø±ÙØªÙ† Ø§Ø³Ú©ÛŒÙ„ ÙØ¹Ù„ÛŒ)
            const dimensions = viewer.getDimensions(); 
            const maxDimension = Math.max(dimensions.x, dimensions.y, dimensions.z);

            console.log("Ø§Ø¨Ø¹Ø§Ø¯ Ø§ØµÙ„ÛŒ ÙØ§ÛŒÙ„:", maxDimension);

            let targetSize; // Ø³Ø§ÛŒØ² Ù‡Ø¯Ù Ø¨Ù‡ Ù…ØªØ±

            if (currentMode === 'pots') {
                targetSize = 0.5; // Ú¯Ù„Ø¯Ø§Ù†â€ŒÙ‡Ø§ Ø¨Ø§ÛŒØ¯ Ø­Ø¯ÙˆØ¯ ÛµÛ° Ø³Ø§Ù†Øª Ø¨Ø§Ø´Ù†Ø¯
                viewer.setAttribute('shadow-intensity', '1');
                viewer.setAttribute('ar-placement', 'auto');
            } else {
                targetSize = 2.0; // ÙØ±Ø´â€ŒÙ‡Ø§ Ø¨Ø§ÛŒØ¯ Ø­Ø¯ÙˆØ¯ Û² Ù…ØªØ± Ø¨Ø§Ø´Ù†Ø¯
                viewer.setAttribute('shadow-intensity', '0'); // Ø­Ø°Ù Ø³Ø§ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ Ú†Ø³Ø¨ÛŒØ¯Ù† Ø¨Ù‡ Ø²Ù…ÛŒÙ†
                viewer.setAttribute('ar-placement', 'floor'); // Ù‚ÙÙ„ Ø±ÙˆÛŒ Ø²Ù…ÛŒÙ†
            }

            // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¶Ø±ÛŒØ¨: Ø³Ø§ÛŒØ² Ù‡Ø¯Ù ØªÙ‚Ø³ÛŒÙ… Ø¨Ø± Ø³Ø§ÛŒØ² ÙØ¹Ù„ÛŒ
            // Ø§Ú¯Ø± ÙØ§ÛŒÙ„ Û³Û°Û° Ù…ØªØ± Ø¨Ø§Ø´Ø¯ØŒ Ø§ÛŒÙ† Ø¹Ø¯Ø¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Û°.Û°Û°Û¶
            // Ø§Ú¯Ø± ÙØ§ÛŒÙ„ Û± Ù…ØªØ± Ø¨Ø§Ø´Ø¯ØŒ Ø§ÛŒÙ† Ø¹Ø¯Ø¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Û²
            calculatedScale = targetSize / maxDimension;

            // Ø§Ø¹Ù…Ø§Ù„ Ø§Ø³Ú©ÛŒÙ„ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯Ù‡
            applyScale(1); // 1 ÛŒØ¹Ù†ÛŒ Û±Û°Û°Ùª Ø³Ø§ÛŒØ² Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯Ù‡
            
            console.log("Ø¶Ø±ÛŒØ¨ Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯Ù‡:", calculatedScale);
        }

        // ØªØºÛŒÛŒØ± Ø¯Ø³ØªÛŒ Ø¨Ø§ Ø§Ø³Ù„Ø§ÛŒØ¯Ø± (Ø¶Ø±Ø¨Ø¯Ø± Ø¶Ø±ÛŒØ¨ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯Ù‡)
        function manualResize(val) {
            applyScale(val);
            document.getElementById('size-display').innerText = Math.round(val * 100) + "%";
        }

        function applyScale(userMultiplier) {
            const finalScale = calculatedScale * userMultiplier;
            viewer.scale = `${finalScale} ${finalScale} ${finalScale}`;
        }

        // ØªØºÛŒÛŒØ± Ø±Ù†Ú¯
        function tint(color) {
            if (!viewer.model) return;
            const mat = viewer.model.materials[0];
            if (mat) mat.pbrMetallicRoughness.setBaseColorFactor(hexToRgb(color));
        }

        function startAR() {
            if (viewer.canActivateAR) viewer.activateAR();
            else alert("AR not supported on this device");
        }

        function hexToRgb(hex) {
            const r = parseInt(hex.slice(1, 3), 16) / 255;
            const g = parseInt(hex.slice(3, 5), 16) / 255;
            const b = parseInt(hex.slice(5, 7), 16) / 255;
            return [r, g, b, 1];
        }

        init();
    </script>
</body>
</html>